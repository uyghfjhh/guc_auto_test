# 2.6测试用例（测试大量GUC参数同步）修正说明

## 修正时间
- 第一次修正：2025年10月20日 上午8:52
- 第二次修正：2025年10月20日 上午9:00（修正JDBC驱动限制问题）

## 问题概述

2.6测试用例在执行SET GUC参数时，存在多个严重问题导致SET命令执行失败：

1. **JDBC驱动限制**：`client_encoding` 参数被JDBC驱动强制要求为UTF8，不能修改
2. **参数值格式错误**：大量参数值不符合PostgreSQL的SET语法要求（缺少引号）
3. **已废弃的参数**：某些参数在PostgreSQL 12+版本中已被废弃
4. **危险参数**：某些参数可能导致会话问题或需要特殊权限

## 问题根源

问题主要出在 `GucParameterList.java` 文件中：

1. **数据库查询未排除危险参数**：`getGucParametersFromDatabase()` 方法获取了包括 `client_encoding` 在内的所有参数
2. **`generateTestValue()` 方法的引号使用问题**
3. **静态参数列表 `getGucParameters()` 中的无效值和危险参数**

## 关键错误示例

### JDBC驱动限制错误

```
警告: 无法设置参数 client_encoding = 'LATIN1': 
The server's client_encoding parameter was changed to 'LATIN1'. 
The JDBC driver requires client_encoding to be UTF8 for correct operation.
```

**原因**：PostgreSQL JDBC驱动强制要求 `client_encoding` 必须为 `UTF8`，任何修改都会导致驱动报错。

## 详细修正内容

### 修正1：排除危险参数（第二次修正 - 最重要）

#### 1.1 在数据库查询中排除危险参数

**修正前**：
```java
String sql = "SELECT name, setting, unit, context " +
             "FROM pg_settings " +
             "WHERE context IN ('user', 'superuser') " +
             "AND name NOT LIKE 'pg_%' " +
             "ORDER BY name LIMIT " + limit;
```

**问题**：查询会返回所有用户可设置的参数，包括 `client_encoding`、`session_authorization` 等危险参数。

**修正后**：
```java
String sql = "SELECT name, setting, unit, context " +
             "FROM pg_settings " +
             "WHERE context IN ('user', 'superuser') " +
             "AND name NOT LIKE 'pg_%' " +
             "AND name NOT IN (" +
             "  'client_encoding', " +          // JDBC驱动强制要求UTF8
             "  'session_authorization', " +    // 会话授权
             "  'role', " +                     // 角色切换
             "  'listen_addresses', " +         // 服务器级别
             "  'port', " +                     // 服务器级别
             "  'max_connections', " +          // 服务器级别
             "  'shared_buffers', " +           // 服务器级别
             "  'wal_level', " +                // 服务器级别
             "  'max_wal_senders', " +          // 服务器级别
             "  'max_replication_slots', " +    // 服务器级别
             "  'default_tablespace', " +       // 可能不存在的表空间
             "  'default_with_oids', " +        // PostgreSQL 12+已废弃
             "  'replacement_sort_tuples', " +  // PostgreSQL 11+已废弃
             "  'vacuum_cleanup_index_scale_factor' " +
             ") " +
             "ORDER BY name LIMIT " + limit;
```

#### 1.2 在generateTestValue中添加危险参数检查

**新增代码**：
```java
// 对于危险参数，保持原值不变（虽然测试值和默认值相同，但避免设置失败）
if (name.equals("client_encoding") ||      // JDBC驱动强制要求UTF8
    name.equals("session_authorization") || // 会话授权
    name.equals("role") ||                  // 角色切换
    name.equals("default_tablespace")) {    // 可能不存在的表空间
    // 保持原值
    if (currentValue == null || currentValue.isEmpty()) {
        return "''";
    }
    // 如果原值已经有引号，直接返回
    if (currentValue.startsWith("'") && currentValue.endsWith("'")) {
        return currentValue;
    }
    // 添加引号返回
    return "'" + currentValue + "'";
}
```

#### 1.3 从静态参数列表中移除危险参数

**移除的参数**：
- `client_encoding` - JDBC驱动强制要求UTF8，不能修改
- `default_tablespace` - 可能不存在的表空间会导致错误
- `default_with_oids` - PostgreSQL 12+已废弃

**修正后参数数量**：从100个减少到97个

### 修正2: `generateTestValue()` 方法优化（第一次修正）

#### 修正前的问题

```java
// 问题：所有字符串类型参数统一添加单引号
if (name.contains("IntervalStyle")) {
    return "'" + (currentValue.equals("postgres") ? "sql_standard" : "postgres") + "'";
}
```

这会导致生成的SQL语句如：
```sql
SET IntervalStyle = 'sql_standard'  -- ✓ 正确
```

但PostgreSQL的SET语法规则是：
- **布尔值和数值**：不需要引号（`SET enable_seqscan = on`）
- **枚举类型值**：需要引号（`SET IntervalStyle = 'sql_standard'`）
- **时区、编码等**：需要引号（`SET TimeZone = 'UTC'`）

#### 修正后的改进

**新增浮点数处理**：
```java
// 浮点数参数 - 不需要引号
try {
    double doubleValue = Double.parseDouble(currentValue);
    if (doubleValue == 0) {
        return "1.0";
    } else {
        return String.valueOf(doubleValue * 1.5);
    }
} catch (NumberFormatException e) {
    // 不是浮点数，继续尝试其他类型
}
```

**修正时区参数**：
```java
// 使用PRC代替Asia/Shanghai，更通用
else if (name.contains("TimeZone") || name.equals("log_timezone")) {
    return "'" + (currentValue.equals("UTC") ? "PRC" : "UTC") + "'";
}
```

**修正编码参数**：
```java
// 避免SQL_ASCII可能不被支持
else if (name.equals("client_encoding")) {
    return "'" + (currentValue.equals("UTF8") ? "LATIN1" : "UTF8") + "'";
}
```

**修正locale参数**：
```java
// 保持原值不变，避免设置无效的locale
else if (name.startsWith("lc_")) {
    return "'" + currentValue + "'";
}
```

**新增application_name和default_tablespace处理**：
```java
else if (name.equals("application_name")) {
    return "'" + (currentValue.isEmpty() ? "test_app" : currentValue + "_modified") + "'";
} else if (name.equals("default_tablespace")) {
    // 保持原值，避免设置不存在的表空间
    return "'" + (currentValue.isEmpty() ? "" : currentValue) + "'";
}
```

### 修正3: 静态参数列表修正（第一次和第二次修正）

#### 字符串类型参数（需要引号）

**修正前**：
```java
params.put("DateStyle", new String[]{"ISO, MDY", "ISO, DMY"});
params.put("IntervalStyle", new String[]{"postgres", "sql_standard"});
params.put("TimeZone", new String[]{"UTC", "Asia/Shanghai"});
params.put("client_encoding", new String[]{"UTF8", "SQL_ASCII"});
params.put("default_tablespace", new String[]{"", "pg_default"});
```

**第一次修正后**：
```java
params.put("DateStyle", new String[]{"'ISO, MDY'", "'ISO, DMY'"});
params.put("IntervalStyle", new String[]{"'postgres'", "'sql_standard'"});
params.put("TimeZone", new String[]{"'UTC'", "'PRC'"});  // 使用PRC更通用
params.put("client_encoding", new String[]{"'UTF8'", "'LATIN1'"});  // 避免SQL_ASCII
params.put("default_tablespace", new String[]{"''", "''"});  // 保持空值
```

**第二次修正后（最终版本）**：
```java
params.put("DateStyle", new String[]{"'ISO, MDY'", "'ISO, DMY'"});
params.put("IntervalStyle", new String[]{"'postgres'", "'sql_standard'"});
params.put("TimeZone", new String[]{"'UTC'", "'PRC'"});  // 使用PRC更通用
// client_encoding 已移除 - JDBC驱动强制要求UTF8
// default_tablespace 已移除 - 可能不存在的表空间
```

#### locale参数（避免不存在的locale）

**修正前**：
```java
params.put("lc_messages", new String[]{"C", "en_US.UTF-8"});
params.put("lc_monetary", new String[]{"C", "en_US.UTF-8"});
params.put("lc_numeric", new String[]{"C", "en_US.UTF-8"});
params.put("lc_time", new String[]{"C", "en_US.UTF-8"});
```

**修正后**：
```java
// 保持C locale，避免en_US.UTF-8可能不存在
params.put("lc_messages", new String[]{"'C'", "'C'"});
params.put("lc_monetary", new String[]{"'C'", "'C'"});
params.put("lc_numeric", new String[]{"'C'", "'C'"});
params.put("lc_time", new String[]{"'C'", "'C'"});
```

> **注意**：由于locale在不同系统中可能不同，保持原值是最安全的选择。虽然这意味着测试值和默认值相同，但避免了SET失败的风险。

#### search_path参数（移除问题字符）

**修正前**：
```java
params.put("search_path", new String[]{"\"$user\", public", "public, pg_catalog"});
```

**修正后**：
```java
params.put("search_path", new String[]{"'public'", "'pg_catalog, public'"});
```

#### 日志相关参数（需要引号）

**修正前**：
```java
params.put("log_min_messages", new String[]{"warning", "notice"});
params.put("log_statement", new String[]{"none", "all"});
params.put("log_error_verbosity", new String[]{"default", "verbose"});
params.put("log_timezone", new String[]{"UTC", "Asia/Shanghai"});
params.put("application_name", new String[]{"", "test_app"});
```

**修正后**：
```java
params.put("log_min_messages", new String[]{"'warning'", "'notice'"});
params.put("log_statement", new String[]{"'none'", "'all'"});
params.put("log_error_verbosity", new String[]{"'default'", "'verbose'"});
params.put("log_timezone", new String[]{"'UTC'", "'PRC'"});
params.put("application_name", new String[]{"''", "'test_app'"});  // 空字符串也需要引号
```

#### 事务相关参数（需要引号）

**修正前**：
```java
params.put("backslash_quote", new String[]{"safe_encoding", "on"});
params.put("default_tablespace", new String[]{"", "pg_default"});
params.put("default_transaction_isolation", new String[]{"read committed", "serializable"});
params.put("session_replication_role", new String[]{"origin", "replica"});
```

**修正后**：
```java
params.put("backslash_quote", new String[]{"'safe_encoding'", "'on'"});
params.put("default_tablespace", new String[]{"''", "''"});  // 保持空值
params.put("default_transaction_isolation", new String[]{"'read committed'", "'serializable'"});
params.put("session_replication_role", new String[]{"'origin'", "'replica'"});
```

#### 其他参数（需要引号）

**修正前**：
```java
params.put("bytea_output", new String[]{"hex", "escape"});
params.put("xmlbinary", new String[]{"base64", "hex"});
params.put("xmloption", new String[]{"content", "document"});
params.put("constraint_exclusion", new String[]{"partition", "on"});
params.put("trace_recovery_messages", new String[]{"log", "notice"});
```

**修正后**：
```java
params.put("bytea_output", new String[]{"'hex'", "'escape'"});
params.put("xmlbinary", new String[]{"'base64'", "'hex'"});
params.put("xmloption", new String[]{"'content'", "'document'"});
params.put("constraint_exclusion", new String[]{"'partition'", "'on'"});
params.put("trace_recovery_messages", new String[]{"'log'", "'notice'"});
```

#### 成本参数（浮点数）

**修正前**：
```java
params.put("seq_page_cost", new String[]{"1", "2"});
params.put("parallel_setup_cost", new String[]{"1000", "2000"});
```

**修正后**：
```java
params.put("seq_page_cost", new String[]{"1.0", "2.0"});
params.put("parallel_setup_cost", new String[]{"1000.0", "2000.0"});
```

## PostgreSQL SET语法规则总结

| 参数类型 | 是否需要引号 | 示例 |
|---------|------------|------|
| 布尔值 | ✗ 不需要 | `SET enable_seqscan = on` |
| 整数 | ✗ 不需要 | `SET work_mem = 4096` |
| 浮点数 | ✗ 不需要 | `SET seq_page_cost = 1.0` |
| 字符串/枚举 | ✓ 需要 | `SET DateStyle = 'ISO, MDY'` |
| 时区 | ✓ 需要 | `SET TimeZone = 'UTC'` |
| 编码 | ✓ 需要 | `SET client_encoding = 'UTF8'` |
| 日志级别 | ✓ 需要 | `SET log_min_messages = 'warning'` |

## 修正影响范围

### 修改的文件
- `/home/postgres/fly_dev/guc_auto_test/src/test/java/com/fbasecman/guc/GucParameterList.java`

### 影响的测试用例
- `testCase2_6_MassiveGucSync_SimpleProtocol()` - 2.6测试用例（Simple协议）
- `testCase2_6_MassiveGucSync_ExtendedProtocol()` - 2.6测试用例（Extended协议）

## 预期效果

修正后，2.6测试用例应该能够：
1. ✓ 成功执行所有SET GUC参数命令
2. ✓ 正确验证参数在连接复用时的重置行为
3. ✓ 正确验证参数在新连接中的同步行为
4. ✓ 减少因参数值无效导致的SET失败

## 注意事项

1. **locale参数**：由于不同系统的locale配置不同，lc_*参数的测试值保持与默认值相同，这是最安全的做法
2. **表空间参数**：default_tablespace保持空值，避免设置不存在的表空间
3. **动态获取参数**：优先使用 `getGucParametersFromDatabase()` 从数据库动态获取参数，这样能获取到实际环境中可用的参数和有效值
4. **某些参数可能需要超级用户权限**：测试时确保使用具有足够权限的数据库用户

## 验证建议

执行测试用例前，建议：
1. 检查数据库用户权限（是否为超级用户或具有足够权限）
2. 查看测试日志中的"成功设置参数数量"和"失败参数数量"
3. 对于失败的参数，检查是否需要特殊权限或系统配置

## 相关文档

- PostgreSQL SET命令文档：https://www.postgresql.org/docs/current/sql-set.html
- PostgreSQL GUC参数文档：https://www.postgresql.org/docs/current/runtime-config.html
