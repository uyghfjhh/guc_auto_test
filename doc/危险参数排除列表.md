# 危险参数排除列表

## 说明

在2.6测试用例中，以下GUC参数已被排除，不会被测试。这些参数要么会导致JDBC驱动错误，要么需要特殊权限，或者已被废弃。

## 排除的参数列表

### 1. JDBC驱动限制参数（⚠️ 最关键）

| 参数名 | 原因 | 错误信息示例 |
|--------|------|----------|
| `client_encoding` | JDBC驱动强制要求UTF8 | The JDBC driver requires client_encoding to be UTF8 for correct operation |
| `DateStyle` | JDBC驱动要求以ISO开头，不允许修改 | The server's DateStyle parameter was changed to 'ISO, DMY'. The JDBC driver requires DateStyle to begin with ISO for correct operation |
| `TimeZone` | JDBC驱动敏感参数 | 可能导致时区转换错误 |
| `IntervalStyle` | JDBC驱动敏感参数 | 可能导致间隔解析错误 |

**影响**：如果修改这些参数，JDBC驱动会报错或发出警告，导致连接不稳定。即使新值看起来是合法的（如DateStyle从'ISO, MDY'改为'ISO, DMY'），JDBC驱动也不允许修改。

### 2. 会话授权/角色相关参数

| 参数名 | 原因 |
|--------|------|
| `session_authorization` | 修改会话授权可能导致权限问题 |
| `role` | 角色切换可能导致测试失败 |

**影响**：这些参数影响当前会话的权限和身份，修改可能导致后续SQL执行失败。

### 3. 服务器级别参数（需要重启或特殊权限）

| 参数名 | 原因 |
|--------|------|
| `listen_addresses` | 需要重启服务器 |
| `port` | 需要重启服务器 |
| `max_connections` | 需要重启服务器 |
| `shared_buffers` | 需要重启服务器 |
| `wal_level` | 需要重启服务器 |
| `max_wal_senders` | 需要重启服务器 |
| `max_replication_slots` | 需要重启服务器 |

**影响**：这些参数的修改需要重启PostgreSQL服务器才能生效，在会话级别设置会失败。

### 4. 可能不存在的资源

| 参数名 | 原因 |
|--------|------|
| `default_tablespace` | 可能指向不存在的表空间 |

**影响**：如果指定的表空间不存在，SET命令会失败。

### 5. 已废弃的参数（PostgreSQL 11+/12+）

| 参数名 | 废弃版本 | 原因 |
|--------|---------|------|
| `replacement_sort_tuples` | PostgreSQL 11+ | 已废弃 |
| `default_with_oids` | PostgreSQL 12+ | OID系统列已被移除 |
| `vacuum_cleanup_index_scale_factor` | - | 可能引起问题 |

**影响**：在新版本PostgreSQL中，这些参数可能不存在或已被移除，设置会导致错误。

## 代码实现

### 数据库查询排除

```sql
SELECT name, setting, unit, context 
FROM pg_settings 
WHERE context IN ('user', 'superuser')
AND name NOT LIKE 'pg_%'
AND name NOT IN (
  -- JDBC驱动敏感参数（最关键）
  'client_encoding',
  'DateStyle',
  'TimeZone',
  'IntervalStyle',
  -- 会话授权
  'session_authorization',
  'role',
  -- 服务器级别参数
  'listen_addresses',
  'port',
  'max_connections',
  'shared_buffers',
  'wal_level',
  'max_wal_senders',
  'max_replication_slots',
  -- 资源和已废弃参数
  'default_tablespace',
  'default_with_oids',
  'replacement_sort_tuples',
  'vacuum_cleanup_index_scale_factor'
)
ORDER BY name
```

### generateTestValue中的保护

对于可能在查询中漏掉的危险参数，在 `generateTestValue()` 方法中添加了额外保护：

```java
if (name.equals("client_encoding") ||
    name.equals("session_authorization") ||
    name.equals("role") ||
    name.equals("default_tablespace")) {
    // 保持原值不变
    return "'" + currentValue + "'";
}
```

## 统计信息

- **原始参数数量**：100个
- **排除的危险参数**：6个 (client_encoding, DateStyle, TimeZone, IntervalStyle, default_tablespace, default_with_oids)
- **最终参数数量**：94个
- **数据库查询排除**：17个参数（包括JDBC敏感参数、服务器级别参数、已废弃参数）

## 测试建议

1. **优先使用动态获取**：使用 `getGucParametersFromDatabase()` 从数据库动态获取参数，自动排除危险参数
2. **检查PostgreSQL版本**：某些参数在不同版本中可能不同，动态获取能自动适配
3. **监控失败参数**：测试时关注"失败参数数量"，如果过多需要进一步排查
4. **权限检查**：确保测试用户有足够权限修改参数（最好是超级用户）

## 相关文档

- PostgreSQL GUC参数文档：https://www.postgresql.org/docs/current/runtime-config.html
- JDBC驱动文档：https://jdbc.postgresql.org/documentation/
- 2.6测试用例修正说明：`doc/2.6测试用例修正说明.md`
